{% extends "base.html" %}

{% block title %}{{ roadmap.title }} | CE Intern Onboarding Bootcamp{% endblock %}

{% block content %}
<style>
  body { margin: 0; }
  #cy { height: 70vh; width: 100%; border: 1px solid #e5e7eb; border-radius: 12px; }
  button { padding: 6px 10px; border: 1px solid #ddd; border-radius: 8px; background: #fff; cursor: pointer; }
  #dbg { font-size: 12px; color: #6b7280; margin: 6px 0 10px; }
  #err { white-space: pre-wrap; color: #b91c1c; font-size: 12px; margin-top: 8px; }
</style>

<h2 style="margin-bottom:8px;">{{ roadmap.title }}</h2>
<button id="toggle-beginner">Beginner version</button>
<div id="dbg">Server built {{ node_count }} nodes / {{ edge_count }} edges</div>
<div id="cy"></div>
<div id="sidebar"
     style="display:none; margin-top:12px; padding:12px; border:1px solid #e5e7eb; border-radius:12px;">
  <h3 id="sb-title" style="margin:0 0 4px 0; font-weight:700;"></h3>
  <p id="sb-body" style="margin:0; color:#374151;"></p>
</div>

<div id="err"></div>

{# Safely embed the graph data from the view #}
{{ elements|json_script:"elements-data" }}

<!-- Load Cytoscape -->
<script src="https://unpkg.com/cytoscape@3.27.0/dist/cytoscape.min.js"></script>

<script>
  const raw = document.getElementById("elements-data").textContent || "[]";
  const elements = JSON.parse(raw);

  if (!elements.length) {
    document.getElementById("cy").style.display = "none";
    document.getElementById("err").textContent = "Under construction â€” no nodes yet for this roadmap.";
  } else {
    const cy = cytoscape({
      container: document.getElementById('cy'),
      elements,
      layout: {
        name: 'breadthfirst',
        directed: true,
        padding: 40
      },
      boxSelectionEnabled: false,
      style: [
        {
          selector: 'node',
          style: {
            'shape': 'round-rectangle',
            'background-color': '#E3F2FD',
            'border-color': '#2196F3',
            'border-width': 2,
            'label': 'data(label)',
            'color': '#0b1220',
            'font-size': 16,
            'font-weight': '600',
            'text-valign': 'center',
            'text-halign': 'center',
            'width': 180,
            'height': 60,
            'shadow-blur': 8,
            'shadow-color': '#90CAF9',
            'shadow-opacity': 0.6,
          }
        },
        {
          selector: 'edge',
          style: {
            'width': 3,
            'line-color': '#90CAF9',
            'target-arrow-color': '#64B5F6',
            'target-arrow-shape': 'triangle',
            'curve-style': 'bezier'
          }
        }, 
        {
          selector: 'node.link',
          style: {
            'border-color': '#0EA5E9',
            'border-width': 3,
            'background-color': '#E0F2FE'
          }
        },
        {
          selector: 'node.hovered',
          style: {
            'shadow-blur': 16,
            'shadow-opacity': 0.9
          }
        }
      ]
    });
    const container = document.getElementById('cy');
    const sidebar = document.getElementById('sidebar');
  const sbTitle = document.getElementById('sb-title');
  const sbBody  = document.getElementById('sb-body');

  function openSidebarWith(html, title) {
    sbTitle.textContent = title || "Details";
    sbBody.innerHTML = html;                     // allow rich markup
    sidebar.style.display = 'block';
  }

  cy.on('tap', 'node', async (e) => {
    const n = e.target;
    const url = n.data('url');
    const key = n.data('key') || n.id();

    if (url) { window.location.href = url; return; }

    try {
      const res = await fetch(`/roadmap/node/${key}/sidebar/`, { headers: { "X-Requested-With": "fetch" }});
      const html = await res.text();
      openSidebarWith(html, n.data('label'));
    } catch (err) {
      openSidebarWith("<p style='color:#b91c1c;'>Failed to load details.</p>", n.data('label'));
    }
  });

    cy.ready(() => cy.fit());
  }
</script>
{% endblock %}
